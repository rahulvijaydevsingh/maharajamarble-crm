
# Plan: Customer Duplicate Prevention, Name Hover Fix, and Horizontal Scrollbar with Sticky Headers

## Overview

This plan addresses three UX/data quality issues:
1. **Duplicate Prevention**: Customers can currently be created with the same phone number - we'll add customer table checking to the duplicate detection
2. **Name Hover Shift**: View/Edit buttons appearing on hover cause layout shift - we'll use an overlay approach like the Leads page
3. **Horizontal Scrollbar + Sticky Headers**: Apply the same scrolling pattern from the Leads page to Customers, Tasks, and Professionals tables

---

## 1. Duplicate Customer Prevention

### Problem
The current duplicate check (`usePhoneDuplicateCheck` and `useEntityPhoneDuplicateCheck`) only checks the `leads` and `professionals` tables, not the `customers` table. This allows duplicate customer records to be created.this double coustomer entry happedn probabally because a lead was converted to a custoemr and a lead was later generated by the custoemr details and when that lead was closed a new customer account was created .

### Solution
Extend the duplicate checking to also query the `customers` table before allowing a new customer to be created.when a lead is converted from a customer and laead is to be converted to the customer. then we can merge the information together in the first lead/ customer. 

### Changes Required

**File: `src/hooks/useEntityPhoneDuplicateCheck.ts`**
- Add `"customers"` to the supported `EntityType` union
- Add a new check block for customers table (similar to leads/professionals)
- Return type `"customer"` when a match is found in customers table

**File: `src/components/leads/smart-form/ContactDetailsSection.tsx`**
- Update the duplicate check call to include `customers` in the entities array when used from the SmartCustomerForm

**File: `src/components/customers/SmartCustomerForm.tsx`**
- Ensure duplicate results properly show customer matches
- Update the duplicate warning message to mention existing customer records

---

## 2. Fix Name Hover Shift Issue

### Problem
In the Customers table, when hovering over a customer name, the View/Edit buttons appear below the name using `hidden group-hover/name:flex`, causing the row height to shift.

### Solution
Use the same fixed-height overlay approach from the Leads table:
- Set a fixed height on the name cell container
- Use absolute positioning for both the name and the hover overlay
- Use opacity transition instead of display toggle

### Changes Required

**File: `src/components/customers/EnhancedCustomerTable.tsx`**

Update the `renderCell` function for the "name" case (lines 588-619):

```tsx
case "name":
  return (
    <div className="relative h-[40px] flex items-center font-medium min-w-[160px]" onClick={(e) => e.stopPropagation()}>
      <span className="absolute inset-0 flex items-center">{customer.name}</span>
      <div className="absolute inset-0 flex items-center opacity-0 hover:opacity-100 bg-background/90 transition-opacity">
        <span 
          className="mr-2 cursor-pointer hover:text-primary hover:underline"
          onClick={() => handleViewCustomer(customer)}
        >
          {customer.name}
        </span>
        <div className="flex items-center gap-1">
          <Button 
            variant="ghost" 
            size="sm" 
            className="h-5 px-2 text-xs text-muted-foreground hover:text-foreground"
            onClick={() => handleViewCustomer(customer)}
          >
            View
          </Button>
          {canEdit("customers") && (
            <Button 
              variant="ghost" 
              size="sm" 
              className="h-5 px-2 text-xs text-muted-foreground hover:text-foreground"
              onClick={() => handleEditCustomer(customer)}
            >
              Edit
            </Button>
          )}
        </div>
      </div>
    </div>
  );
```

---

## 3. Horizontal Scrollbar with Sticky Headers

### Problem
The Customers, Tasks, and Professionals tables don't have the same smooth horizontal scrolling experience as the Leads page. The issue is that these pages wrap the shadcn `<Table>` component inside `ScrollableTableContainer`, but the `<Table>` component has its own scroll wrapper which interferes.

### Solution
Follow the Leads table pattern:
1. Use `ScrollableTableContainer` as the outer wrapper
2. Use a plain `<table>` element instead of the shadcn `<Table>` component
3. Keep the shadcn `<TableHeader>`, `<TableBody>`, `<TableRow>`, `<TableHead>`, `<TableCell>` components (they work with plain tables)
4. Add proper sticky header styling with z-index and background

### Changes Required

**File: `src/components/customers/EnhancedCustomerTable.tsx`**
- Replace `<Table>` with plain `<table className="w-full caption-bottom text-sm">`
- Update `<TableHeader>` with `sticky top-0 z-20 bg-background`
- Update header row with `border-b-2 border-border shadow-sm`
- Ensure all `<TableHead>` cells have `bg-background sticky top-0`

**File: `src/components/tasks/EnhancedTaskTable.tsx`**
- Same pattern: Replace `<Table>` with plain `<table>`
- Update sticky header styling

**File: `src/components/professionals/EnhancedProfessionalTable.tsx`**
- Same pattern: Replace `<Table>` with plain `<table>`
- Update sticky header styling

---

## Implementation Order

1. **Phase 1 - Duplicate Prevention** (highest priority for data quality)
   - Update `useEntityPhoneDuplicateCheck.ts` to include customers table
   - Update form components to use the enhanced check

2. **Phase 2 - Name Hover Fix** (quick UX improvement)
   - Update the name cell rendering in `EnhancedCustomerTable.tsx`

3. **Phase 3 - Scrollbar + Sticky Headers** (consistent UX across all tables)
   - Update Customers table
   - Update Tasks table
   - Update Professionals table

---

## Technical Notes

### Duplicate Check Flow
```
User enters phone → Debounce 500ms → Check leads → Check professionals → Check customers → Show warning if found
```

### Table Scroll Architecture
```
ScrollableTableContainer (manages horizontal scroll + top scrollbar)
  └─ <table> (plain HTML table, no wrapper)
       └─ TableHeader (sticky top-0 z-20 bg-background)
            └─ TableRow (border-b-2 shadow-sm)
                 └─ TableHead (bg-background sticky top-0)
       └─ TableBody
            └─ TableRow → TableCell
```

### Name Cell Hover Pattern
```
Container (relative, fixed height 40px)
  ├─ Name text (absolute, always visible)
  └─ Hover overlay (absolute, opacity-0 → opacity-100 on hover)
       ├─ Name (clickable)
       └─ View | Edit buttons
```

---

## Testing Checklist

After implementation:
- [ ] Try to create a customer with an existing customer's phone number → Should show duplicate warning
- [ ] Hover over customer name → No vertical shift, smooth overlay appears
- [ ] Scroll horizontally in Customers table → Top scrollbar syncs, headers stay fixed
- [ ] Scroll horizontally in Tasks table → Same behavior
- [ ] Scroll horizontally in Professionals table → Same behavior
- [ ] Verify all tables work on different screen sizes
